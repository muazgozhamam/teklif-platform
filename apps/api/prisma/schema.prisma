generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum OfferStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  CANCELLED
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  password        String
  name            String?
  role            Role     @default(USER)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  offers          Offer[]  @relation("UserOffers")
  consultantDeals Deal[]   @relation("DealConsultant")

  listings         Listing[]
  userListings     Listing[] @relation("UserListings")
  isActive         Boolean   @default(false)
  approvedAt       DateTime?
  approvedByUserId String?

  commissionSnapshotsCreated  CommissionSnapshot[] @relation("CommissionSnapshotCreatedBy")
  commissionSnapshotsApproved CommissionSnapshot[] @relation("CommissionSnapshotApprovedBy")
  commissionAllocations       CommissionAllocation[]
  commissionLedgerEntries     CommissionLedgerEntry[] @relation("CommissionLedgerCreatedBy")
  commissionPayouts           CommissionPayout[] @relation("CommissionPayoutCreatedBy")
  commissionDisputesOpened    CommissionDispute[] @relation("CommissionDisputeOpenedBy")
  commissionDisputesResolved  CommissionDispute[] @relation("CommissionDisputeResolvedBy")
  commissionDisputesAgainst   CommissionDispute[] @relation("CommissionDisputeAgainstUser")
  commissionPeriodLocksCreated CommissionPeriodLock[] @relation("CommissionPeriodLockCreatedBy")
  commissionPeriodLocksUnlocked CommissionPeriodLock[] @relation("CommissionPeriodLockUnlockedBy")
  commissionAuditEvents        CommissionAuditEvent[]

  assignedApplications         Application[]      @relation("ApplicationAssignee")
  applicationNotes             ApplicationNote[]  @relation("ApplicationNoteAuthor")
  applicationEvents            ApplicationEvent[] @relation("ApplicationEventActor")
}

enum Role {
  USER
  ADMIN
  BROKER
  CONSULTANT
  HUNTER
}

model Lead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Kullanıcının ilk serbest metni
  initialText String

  // Durum (sonra pipeline yapacağız)
  status LeadStatus @default(OPEN)

  // Kaynak (HUNTER vs PUBLIC vs BROKER vs ...)
  sourceRole   String?
  // Kaynağı oluşturan kullanıcı (Hunter gönderimleri için)
  sourceUserId String?

  // İsteğe bağlı: admin/agent ataması (sonra User ile ilişkilendiririz)
  assignedTo String?

  // Cevaplar
  answers LeadAnswer[]
  offers  Offer[]
  deal    Deal?
}

model LeadAnswer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  key      String // soru anahtarı (e.g. "city")
  question String
  answer   String
}

enum LeadStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED

  ASSIGNED
  OFFERED
  WON
  LOST
  ARCHIVED
}

enum DealStatus {
  OPEN
  READY_FOR_MATCHING
  ASSIGNED
  WON
  LOST
}

model Offer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  consultantId String
  consultant   User    @relation(name: "UserOffers", fields: [consultantId], references: [id], onDelete: Restrict)
  amount       Int
  currency     String  @default("TRY")
  description  String?

  status OfferStatus @default(DRAFT)

  sentAt    DateTime?
  decidedAt DateTime?

  @@index([leadId, status])
  @@index([consultantId, status])
}

model Deal {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status DealStatus @default(OPEN)

  // LeadAnswer snapshot (LeadAnswer key’lerinden dolacak)
  city     String?
  district String?
  type     String? // kiralık/satılık
  rooms    String?

  leadId       String   @unique
  consultantId String?
  consultant   User?    @relation(name: "DealConsultant", fields: [consultantId], references: [id], onDelete: SetNull)
  listingId    String?
  listing      Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  commissionSnapshots CommissionSnapshot[]
  commissionLedger    CommissionLedgerEntry[]
  commissionDisputes  CommissionDispute[]

  @@index([status])
  @@index([listingId])
}

enum ListingStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

model Listing {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status ListingStatus @default(DRAFT)

  // Owner consultant (danışman)
  consultantId String
  consultant   User   @relation("UserListings", fields: [consultantId], references: [id], onDelete: Restrict)

  // Core searchable fields (MVP)
  city     String?
  district String?
  type     String?
  rooms    String?

  title       String
  description String?
  price       Int?
  currency    String  @default("TRY")

  deals  Deal[]
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@index([status])
  @@index([consultantId, status])
  @@index([city, district, type])
}

model HunterApplication {
  id       String            @id @default(cuid())
  fullName String
  phone    String
  email    String?
  city     String?
  district String?
  note     String?
  status   ApplicationStatus @default(PENDING)

  reviewedByUserId String?
  reviewNote       String?
  reviewedAt       DateTime?

  // Optional attribution / future use:
  sponsorId String?
  brokerId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([phone])
  @@index([email])
  @@index([brokerId])
  @@index([sponsorId])
}

enum ApplicationType {
  CUSTOMER_LEAD
  PORTFOLIO_LEAD
  CONSULTANT_CANDIDATE
  HUNTER_CANDIDATE
  BROKER_CANDIDATE
  PARTNER_CANDIDATE
  CORPORATE_LEAD
  SUPPORT_REQUEST
  COMPLAINT
}

enum ApplicationPipelineStatus {
  NEW
  QUALIFIED
  IN_REVIEW
  MEETING_SCHEDULED
  APPROVED
  ONBOARDED
  REJECTED
  CLOSED
}

enum ApplicationPriority {
  P0
  P1
  P2
}

enum ApplicationEventType {
  CREATED
  STATUS_CHANGED
  ASSIGNED
  NOTE_ADDED
  TAG_ADDED
  TAG_REMOVED
  CLOSED
}

model Application {
  id                  String                    @id @default(cuid())
  type                ApplicationType
  status              ApplicationPipelineStatus @default(NEW)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  fullName            String
  phone               String
  email               String?
  city                String?
  district            String?
  notes               String?
  source              String?
  payload             Json?
  assignedToUserId    String?
  priority            ApplicationPriority       @default(P2)
  slaFirstResponseAt  DateTime?
  firstResponseAt     DateTime?
  lastActivityAt      DateTime                  @default(now())
  tags                String[]                  @default([])
  dedupeKey           String?                   @unique

  assignedTo          User?                     @relation("ApplicationAssignee", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  appNotes            ApplicationNote[]
  events              ApplicationEvent[]

  @@index([type, status, createdAt])
  @@index([assignedToUserId, status])
  @@index([priority, createdAt])
  @@index([phone])
  @@index([email])
}

model ApplicationNote {
  id            String      @id @default(cuid())
  applicationId String
  authorUserId  String
  body          String
  createdAt     DateTime    @default(now())

  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  author        User        @relation("ApplicationNoteAuthor", fields: [authorUserId], references: [id], onDelete: Restrict)

  @@index([applicationId, createdAt])
}

model ApplicationEvent {
  id            String               @id @default(cuid())
  applicationId String
  actorUserId   String?
  eventType     ApplicationEventType
  meta          Json?
  createdAt     DateTime             @default(now())

  application   Application          @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  actor         User?                @relation("ApplicationEventActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([applicationId, createdAt])
  @@index([eventType, createdAt])
}

enum CommissionCalcMethod {
  PERCENTAGE
  FIXED
}

enum CommissionSnapshotStatus {
  DRAFT
  EARNED
  PENDING_APPROVAL
  APPROVED
  REVERSED
}

enum CommissionRole {
  HUNTER
  CONSULTANT
  BROKER
  SYSTEM
}

enum CommissionLineStatus {
  PENDING
  APPROVED
  PARTIAL
  PAID
  REVERSED
}

enum CommissionTaxModel {
  NONE
  WITHHOLDING
  VAT
}

enum CommissionLedgerEntryType {
  EARN
  PAYOUT
  REVERSAL
  ADJUSTMENT
}

enum LedgerDirection {
  CREDIT
  DEBIT
}

enum CommissionPayoutMethod {
  BANK_TRANSFER
  CASH
  OTHER
}

enum CommissionDisputeType {
  ATTRIBUTION
  AMOUNT
  ROLE
  OTHER
}

enum CommissionDisputeStatus {
  OPEN
  UNDER_REVIEW
  ESCALATED
  RESOLVED_APPROVED
  RESOLVED_REJECTED
}

enum CommissionRoundingRule {
  ROUND_HALF_UP
  BANKERS
}

enum CommissionAuditAction {
  SNAPSHOT_CREATED
  SNAPSHOT_APPROVED
  SNAPSHOT_REVERSED
  PAYOUT_CREATED
  DISPUTE_CREATED
  DISPUTE_STATUS_CHANGED
  PERIOD_LOCK_CREATED
  PERIOD_LOCK_RELEASED
  DISPUTE_ESCALATED
}

enum CommissionAuditEntityType {
  SNAPSHOT
  PAYOUT
  DISPUTE
  PERIOD_LOCK
  SYSTEM
}

model CommissionPolicyVersion {
  id                            String                 @id @default(cuid())
  name                          String
  calcMethod                    CommissionCalcMethod   @default(PERCENTAGE)
  commissionRateBasisPoints     Int?
  fixedCommissionMinor          BigInt?
  currency                      String                 @default("TRY")
  hunterPercentBasisPoints      Int
  consultantPercentBasisPoints  Int
  brokerPercentBasisPoints      Int
  systemPercentBasisPoints      Int
  roundingRule                  CommissionRoundingRule @default(ROUND_HALF_UP)
  effectiveFrom                 DateTime
  effectiveTo                   DateTime?
  isActive                      Boolean                @default(true)
  createdAt                     DateTime               @default(now())

  snapshots                     CommissionSnapshot[]

  @@index([isActive, effectiveFrom, effectiveTo])
}

model CommissionSnapshot {
  id                 String                   @id @default(cuid())
  dealId             String
  version            Int                      @default(1)
  idempotencyKey     String                   @unique
  status             CommissionSnapshotStatus @default(PENDING_APPROVAL)
  baseAmountMinor    BigInt
  poolAmountMinor    BigInt
  currency           String                   @default("TRY")
  policyVersionId    String
  policySnapshotJson Json
  createdBy          String
  createdAt          DateTime                 @default(now())
  approvedBy         String?
  approvedAt         DateTime?
  reversedAt         DateTime?
  notes              String?

  deal           Deal                    @relation(fields: [dealId], references: [id], onDelete: Restrict)
  policyVersion  CommissionPolicyVersion @relation(fields: [policyVersionId], references: [id], onDelete: Restrict)
  maker          User                    @relation("CommissionSnapshotCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)
  checker        User?                   @relation("CommissionSnapshotApprovedBy", fields: [approvedBy], references: [id], onDelete: SetNull)
  allocations    CommissionAllocation[]
  ledgerEntries  CommissionLedgerEntry[]
  disputes       CommissionDispute[]

  @@unique([dealId, version])
  @@index([status, createdAt])
}

model CommissionAllocation {
  id                String               @id @default(cuid())
  snapshotId        String
  role              CommissionRole
  userId            String?
  percentBasisPoints Int
  amountMinor       BigInt
  taxModel          CommissionTaxModel   @default(NONE)
  taxRateBasisPoints Int                 @default(0)
  status            CommissionLineStatus @default(PENDING)
  createdAt         DateTime             @default(now())

  snapshot          CommissionSnapshot   @relation(fields: [snapshotId], references: [id], onDelete: Restrict)
  user              User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  ledgerEntries     CommissionLedgerEntry[]
  payoutAllocations CommissionPayoutAllocation[]

  @@index([snapshotId, userId, role])
  @@index([status])
}

model CommissionLedgerEntry {
  id          String                    @id @default(cuid())
  snapshotId  String?
  allocationId String?
  dealId      String
  entryType   CommissionLedgerEntryType
  direction   LedgerDirection
  amountMinor BigInt
  currency    String                    @default("TRY")
  occurredAt  DateTime                  @default(now())
  referenceId String?
  createdBy   String
  memo        String?

  snapshot    CommissionSnapshot?       @relation(fields: [snapshotId], references: [id], onDelete: SetNull)
  allocation  CommissionAllocation?     @relation(fields: [allocationId], references: [id], onDelete: SetNull)
  deal        Deal                      @relation(fields: [dealId], references: [id], onDelete: Restrict)
  creator     User                      @relation("CommissionLedgerCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([dealId, occurredAt])
  @@index([allocationId, occurredAt])
  @@index([entryType, occurredAt])
}

model CommissionPayout {
  id               String                      @id @default(cuid())
  payoutBatchId    String?
  paidAt           DateTime
  method           CommissionPayoutMethod
  referenceNo      String?
  totalAmountMinor BigInt
  currency         String                      @default("TRY")
  createdBy        String
  createdAt        DateTime                    @default(now())

  creator          User                        @relation("CommissionPayoutCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)
  allocations      CommissionPayoutAllocation[]

  @@index([paidAt])
}

model CommissionPayoutAllocation {
  id           String               @id @default(cuid())
  payoutId     String
  allocationId String
  amountMinor  BigInt

  payout       CommissionPayout    @relation(fields: [payoutId], references: [id], onDelete: Restrict)
  allocation   CommissionAllocation @relation(fields: [allocationId], references: [id], onDelete: Restrict)

  @@unique([payoutId, allocationId])
  @@index([allocationId])
}

model CommissionDispute {
  id               String                  @id @default(cuid())
  dealId           String
  snapshotId       String?
  openedBy         String
  againstUserId    String?
  type             CommissionDisputeType
  status           CommissionDisputeStatus @default(OPEN)
  slaDueAt         DateTime
  resolvedAt       DateTime?
  resolvedBy       String?
  resolutionNote   String?
  evidenceMetaJson Json?
  createdAt        DateTime                @default(now())

  deal             Deal                    @relation(fields: [dealId], references: [id], onDelete: Restrict)
  snapshot         CommissionSnapshot?     @relation(fields: [snapshotId], references: [id], onDelete: SetNull)
  opener           User                    @relation("CommissionDisputeOpenedBy", fields: [openedBy], references: [id], onDelete: Restrict)
  resolver         User?                   @relation("CommissionDisputeResolvedBy", fields: [resolvedBy], references: [id], onDelete: SetNull)
  againstUser      User?                   @relation("CommissionDisputeAgainstUser", fields: [againstUserId], references: [id], onDelete: SetNull)

  @@index([status, slaDueAt])
  @@index([dealId, createdAt])
}

model CommissionPeriodLock {
  id          String   @id @default(cuid())
  periodFrom  DateTime
  periodTo    DateTime
  reason      String
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  unlockedBy  String?
  unlockedAt  DateTime?

  creator   User  @relation("CommissionPeriodLockCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)
  unlocker  User? @relation("CommissionPeriodLockUnlockedBy", fields: [unlockedBy], references: [id], onDelete: SetNull)

  @@index([isActive, periodFrom, periodTo])
}

model CommissionAuditEvent {
  id         String                  @id @default(cuid())
  action     CommissionAuditAction
  entityType CommissionAuditEntityType
  entityId   String?
  actorUserId String?
  payloadJson Json?
  createdAt  DateTime                @default(now())

  actor User? @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([action, createdAt])
  @@index([entityType, entityId])
}
